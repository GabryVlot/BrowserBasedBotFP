<!DOCTYPE html>
<head>
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <script src='js/fingerprint2.js'></script>
    <script>

        const missingBind = lackOfJavaScriptEngineFeatures();
        const stackTrace = stackTraces();
        const webSecurity = hasWebSecurity();
        const autoClosePopup = timing();

        function getParams(cb){
            const configuration = document.getElementById('txtConfDesc').value
            if (!configuration || configuration.length === 0){
                alert('Enter configuration description')
                return;
            }

            var fp = new Fingerprint2();
            fp.get(function (result, components) {
                const windowKeys = Object.keys(window);
                const docKeys = Object.keys(window.document);
                const navigatorKeys = Object.keys(window.navigator);

                const params = {
                    "hash": result,
                    "fp": components,
                    "configuration": configuration,
                    "browser": {
                        window: windowKeys,
                        document: docKeys,
                        navigator: navigatorKeys
                    },
                    "misc": {
                        missingBindFunction: missingBind,
                        stackTrace: stackTrace,
                        webSecurity: webSecurity,
                        autoClosePopup: autoClosePopup
                    }
                }
                console.log('send params', params, null, 4);
                if (cb)
                    cb(params);
            });
        }

        function saveFP(){
            var url = window.location.origin + "/api/save_fp";
            var http = new XMLHttpRequest();
            http.open("POST", url, true);

            //Send the proper header information along with the request
            http.setRequestHeader("Content-type", "application/json");
            http.onreadystatechange = function() {//Call a function when the state changes.
//                if(http.readyState == 4 && http.status == 200) {
//                    alert(http.responseText);
//                }
            }

            getParams(function(params){
                http.send(JSON.stringify(params));
            })
        }

        function lackOfJavaScriptEngineFeatures(){
           return (function () {
                if (!Function.prototype.bind) {
               //     console.log("PhantomJS environment detected. #1");
                    return true;
                }
                if (Function.prototype.bind.toString().replace(/bind/g, 'Error') != Error.toString()) {
              //      console.log("PhantomJS environment detected. #2");
                    return true;
                }
                if (Function.prototype.toString.toString().replace(/toString/g, 'Error') != Error.toString()) {
               //     console.log("PhantomJS environment detected. #3");
                    return true;
                }
               // console.log("PhantomJS environment not detected.");
                return false;
            })();
        }

        function timing(){
            var start = Date.now();
            alert('Press OK');
            var elapse = Date.now() - start;
//            if (elapse < 15) {
//                console.log("PhantomJS environment detected. #1");
//            } else {
//                console.log("PhantomJS environment not detected.");
//            }
            return elapse < 15 ? true : false
        }

        function stackTraces(){
//            var html = document.querySelectorAll('html');
//            var oldQSA = document.querySelectorAll;
//            Document.prototype.querySelectorAll = Element.prototype.querySelectorAll = function () {
//                var err;
//                try {
//                    null[0]();
//                } catch (e) {
//                    err = e;
//                }
//                if (indexOfString(err.stack, 'phantomjs') > -1) {
//                    return html;
//                } else {
//                    return oldQSA.apply(this, arguments);
//                }
//            };

            var err;
            try {
                null[0]();
            } catch (e) {
                err = e;
            }
            return err.stack;
//            if (err.stack.indexOf('phantomjs') > -1) {
//                console.log("PhantomJS environment detected.");
//            } else {
//                console.log("PhantomJS environment is not detected.");
//            }
        }

        function hasWebSecurity(){
            var xhr;
            if (window.XMLHttpRequest)
                xhr = new XMLHttpRequest();
            else
                xhr = new window.ActiveXObject("Microsoft.XMLHTTP");

            try {
                xhr.open('GET', 'file:/etc/hosts, false');
            }catch(e){ //I.e. 11
               return true;
            }

            try{
                xhr.send();
            }
            catch(e){
                return false;
            }
            return true;
        }

    </script>
</head>

<div class="ext-box">
    <h1>Detection</h1>
    <div class="int-box">

        <div class="int-box">
            <label>Configuration description:</label>
            <input id="txtConfDesc" type="text" name="confDescr">
        </div>
        <button onclick="saveFP()" id="btnFP">Fingerprint Browser</button>
        <button onclick="lackOfJavaScriptEngineFeatures()" id="btnJavaScriptEngine">JavaScriptEngine</button>
        <button onclick="timing()" id="btnTiming">Timing</button>
        <button onclick="stackTraces()" id="btnStackTraces">StackTraces</button>
        <button onclick="getParams()" id="btnDryRun">Dry run</button>
    </div>
</div>
</html>
