<head>
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <script src='js/fingerprint2.js'></script>
    <script>

        const missingBind = lackOfJavaScriptEngineFeatures();
        const stackTrace = stackTraces();
        const webSecurity = hasWebSecurity();
        const autoClosePopup = timing();

        console.log('Results', missingBind, stackTrace, webSecurity, autoClosePopup);
        function fp(){
            const configuration = document.getElementById('txtConfDesc').value
            if (!configuration || configuration.length === 0){
                alert('Enter configuration description')
                return;
            }

            var fp = new Fingerprint2();
            fp.get(function (result, components) {
                console.log(result); //a hash, representing your device fingerprint
                console.log(components); // an array of FP components
                saveFP(result, components, configuration);
            });
        }

        function saveFP(hash, components, configuration){
            var http = new XMLHttpRequest();

            var url = window.location.origin + "/api/save_fp";
            http.open("POST", url, true);

            const windowKeys = Object.keys(window);
            const docKeys = Object.keys(window.document);
            const navigatorKeys = Object.keys(window.navigator);

            const params = {
                "hash": hash,
                "fp": components,
                "configuration": configuration,
                "browser": {
                    window: windowKeys,
                    document: docKeys,
                    navigator: navigatorKeys
                },
                "misc": {
                    missingBindFunction: missingBind,
                    stackTrace: stackTrace,
                    webSecurity: webSecurity,
                    autoClosePopup: autoClosePopup
                }
            }

            //Send the proper header information along with the request
            http.setRequestHeader("Content-type", "application/json");


            http.onreadystatechange = function() {//Call a function when the state changes.
//                if(http.readyState == 4 && http.status == 200) {
//                    alert(http.responseText);
//                }
            }

            for (var i =0; i<components.length;i++){
                const entry = components[i];
                //if (entry.key === 'js_fonts')
                //    console.log('@@@FONts', entry.value);
            }

            console.log('send params', JSON.stringify(params, null, 4));
            http.send(JSON.stringify(params));
        }

        function lackOfJavaScriptEngineFeatures(){
           return (function () {
                if (!Function.prototype.bind) {
               //     console.log("PhantomJS environment detected. #1");
                    return true;
                }
                if (Function.prototype.bind.toString().replace(/bind/g, 'Error') != Error.toString()) {
              //      console.log("PhantomJS environment detected. #2");
                    return true;
                }
                if (Function.prototype.toString.toString().replace(/toString/g, 'Error') != Error.toString()) {
               //     console.log("PhantomJS environment detected. #3");
                    return true;
                }
               // console.log("PhantomJS environment not detected.");
                return false;
            })();
        }

        function timing(){
            var start = Date.now();
            alert('Press OK');
            var elapse = Date.now() - start;
//            if (elapse < 15) {
//                console.log("PhantomJS environment detected. #1");
//            } else {
//                console.log("PhantomJS environment not detected.");
//            }
            return elapse < 15 ? true : false
        }

        function stackTraces(){
//            var html = document.querySelectorAll('html');
//            var oldQSA = document.querySelectorAll;
//            Document.prototype.querySelectorAll = Element.prototype.querySelectorAll = function () {
//                var err;
//                try {
//                    null[0]();
//                } catch (e) {
//                    err = e;
//                }
//                if (indexOfString(err.stack, 'phantomjs') > -1) {
//                    return html;
//                } else {
//                    return oldQSA.apply(this, arguments);
//                }
//            };

            var err;
            try {
                null[0]();
            } catch (e) {
                err = e;
            }
            return err.stack;
//            if (err.stack.indexOf('phantomjs') > -1) {
//                console.log("PhantomJS environment detected.");
//            } else {
//                console.log("PhantomJS environment is not detected.");
//            }
        }

        function hasWebSecurity(){
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'file:/etc/hosts, false');
            xhr.onload = function(){
              //  console.log('onLoad', xhr.responseText);
            };
            xhr.onerror = function(e){
              //console.log('Error:', JSON.stringify(e));
            };

            try{
                xhr.send();
            }
            catch(e){
                return false;
            }
            return true;
        }

    </script>
</head>

<div class="ext-box">
    <h1>Detection</h1>
    <div class="int-box">

        <div class="int-box">
            <label>Configuration description:</label>
            <input id="txtConfDesc" type="text" name="confDescr">
        </div>
        <button onclick="fp()" id="btnFP">Fingerprint Browser</button>
        <button onclick="lackOfJavaScriptEngineFeatures()" id="btnJavaScriptEngine">JavaScriptEngine</button>
        <button onclick="timing()" id="btnTiming">Timing</button>
        <button onclick="stackTraces()" id="btnStackTraces">StackTraces</button>
        <button onclick="webSecurity()" id="btnWebSecurity">WebSecurity</button>
    </div>
</div>
