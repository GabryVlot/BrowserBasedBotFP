<!DOCTYPE html>
<head>
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <script src='js/fingerprint2.js'></script>
    <script type="text/javascript" src="js/swfobject.js"></script>
    <script>

        swfobject.registerObject("myId", "9.0.0", "expressInstall.swf");
        const missingBind = lackOfJavaScriptEngineFeatures();
        const stackTrace = stackTraces();
        const webSecurity = hasWebSecurity();
        const autoClosePopup = timing();

        function getParams(cb){
            const configuration = document.getElementById('txtConfDesc').value
            if (!configuration || configuration.length === 0){
                alert('Enter configuration description')
                return;
            }

            const options = {excludeJsFonts: false, swfPath: '/swf/FontList.swf'};
            var fp = new Fingerprint2(options);
            fp.get(function (result, components) {
                const windowKeys = getObjectProperties(window);
                const docKeys = getObjectProperties(document);

                var _navigator = {};
                for (var i in navigator) _navigator[i] = navigator[i];

                delete _navigator.plugins;
                delete _navigator.mimeTypes;
                delete _navigator.language;
                delete _navigator.languages;
                const params = {
                    "hash": result,
                    "fp2": components,
                    "configuration": configuration,
                    "browser": {
                        window: windowKeys,
                        missingBindFunction: missingBind,
                        stackTrace: stackTrace,
                        webSecurity: webSecurity,
                        autoClosePopup: autoClosePopup
                    },
                    "navigator": {
                        mimeTypes: JSON.stringify(navigator.mimeTypes),
                        navigator: JSON.stringify(_navigator),
                        language: navigator.language,
                        languages: navigator.languages,
                    },
                    "document": {
                        docKeys: docKeys,
                        documentElement: toJSON(document.documentElement)
                    }

                }

                console.log('send params', params, null, 4);
                if (cb)
                    cb(params);
            });
        }


        function toJSON(node) {
            node = node || this;
            var obj = {
                nodeType: node.nodeType
            };
            if (node.tagName) {
                obj.tagName = node.tagName.toLowerCase();
            } else
            if (node.nodeName) {
                obj.nodeName = node.nodeName;
            }
            if (node.nodeValue) {
                obj.nodeValue = node.nodeValue;
            }
            var attrs = node.attributes;
            if (attrs) {
                var length = attrs.length;
                var arr = obj.attributes = new Array(length);
                for (var i = 0; i < length; i++) {
                    attr = attrs[i];
                    arr[i] = [attr.nodeName, attr.nodeValue];
                }
            }
            var childNodes = node.childNodes;
            if (childNodes) {
                length = childNodes.length;
                arr = obj.childNodes = new Array(length);
                for (i = 0; i < length; i++) {
                    arr[i] = toJSON(childNodes[i]);
                }
            }
            return obj;
        }

        function getObjectProperties(browserObject){
            const keys = [];
            for (var w in browserObject){ keys.push(w);}
            return keys;
        }

        function saveFP(){
            var url = window.location.origin + "/api/save_fp";
            var http = new XMLHttpRequest();
            http.open("POST", url, true);

            //Send the proper header information along with the request
            http.setRequestHeader("Content-type", "application/json");
            http.onreadystatechange = function() {//Call a function when the state changes.
//                if(http.readyState == 4 && http.status == 200) {
//                    alert(http.responseText);
//                }
            }

            getParams(function(params){
                http.send(JSON.stringify(params));
            })
        }

        function missingImage(){
            var body = document.getElementsByTagName("body")[0];
            var image = document.createElement("img");
            image.src = "http://iloveponeydotcom32188.jg";
            image.setAttribute("id", "fakeimage");
            body.appendChild(image);
            image.onerror = function(){
                if(image.width == 0 && image.height == 0) {
                    console.log("Chrome headless detected");
                }
            }
        }

        function lackOfJavaScriptEngineFeatures(){
           return (function () {
                if (!Function.prototype.bind) {
               //     console.log("PhantomJS environment detected. #1");
                    return true;
                }
                if (Function.prototype.bind.toString().replace(/bind/g, 'Error') != Error.toString()) {
              //      console.log("PhantomJS environment detected. #2");
                    return true;
                }
                if (Function.prototype.toString.toString().replace(/toString/g, 'Error') != Error.toString()) {
               //     console.log("PhantomJS environment detected. #3");
                    return true;
                }
               // console.log("PhantomJS environment not detected.");
                return false;
            })();
        }

        function timing(){
            var start = Date.now();
            alert('Press OK');
            var elapse = Date.now() - start;
//            if (elapse < 15) {
//                console.log("PhantomJS environment detected. #1");
//            } else {
//                console.log("PhantomJS environment not detected.");
//            }
            return elapse < 15 ? true : false
        }

        function stackTraces(){
//            var html = document.querySelectorAll('html');
//            var oldQSA = document.querySelectorAll;
//            Document.prototype.querySelectorAll = Element.prototype.querySelectorAll = function () {
//                var err;
//                try {
//                    null[0]();
//                } catch (e) {
//                    err = e;
//                }
//                if (indexOfString(err.stack, 'phantomjs') > -1) {
//                    return html;
//                } else {
//                    return oldQSA.apply(this, arguments);
//                }
//            };

            var err;
            try {
                null[0]();
            } catch (e) {
                err = e;
            }
            return err.stack;
//            if (err.stack.indexOf('phantomjs') > -1) {
//                console.log("PhantomJS environment detected.");
//            } else {
//                console.log("PhantomJS environment is not detected.");
//            }
        }

        function hasWebSecurity(){
            var xhr;
            if (window.XMLHttpRequest)
                xhr = new XMLHttpRequest();
            else
                xhr = new window.ActiveXObject("Microsoft.XMLHTTP");

            try {
                xhr.open('GET', 'file:/etc/hosts, false');
            }catch(e){ //I.e. 11
               return true;
            }

            try{
                xhr.send();
            }
            catch(e){
                return false;
            }
            return true;
        }

    </script>
</head>
<body>
    <div class="ext-box">
        <h1>Detection</h1>
        <div class="int-box">

            <div class="int-box">
                <label>Configuration description:</label>
                <input id="txtConfDesc" type="text" name="confDescr">
            </div>
            <button onclick="saveFP()" id="btnFP">Fingerprint Browser</button>
            <button onclick="lackOfJavaScriptEngineFeatures()" id="btnJavaScriptEngine">JavaScriptEngine</button>
            <button onclick="timing()" id="btnTiming">Timing</button>
            <button onclick="stackTraces()" id="btnStackTraces">StackTraces</button>
            <button onclick="getParams()" id="btnDryRun">Dry run</button>
        </div>




    </div>

    <!--<object type="application/x-shockwave-flash" data="swf/test.swf" width="550" height="400" name="movie_name" id="movie_name" align="middle">-->
        <!--<param name="movie" value="swf/test.swf"/>-->
        <!--<a href="http://www.adobe.com/go/getflash">-->
            <!--<img src="http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif" alt="Get Adobe Flash player"/>-->
        <!--</a>-->
    <!--</object>-->
</body>

</html>
